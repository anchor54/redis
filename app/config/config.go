package config

import (
	"fmt"
	"strings"
	"sync"
	"sync/atomic"

	"github.com/codecrafters-io/redis-starter-go/app/utils"
)

// Config holds server configuration
type Config struct {
	Host          string     // Host address to bind to
	Port          int        // Port to listen on
	Role          ServerRole // Server role (master or slave)
	MasterHost    string     // Master host (for replicas only)
	MasterPort    string     // Master port (for replicas only)
	ReplicationID string     // Replication ID (both master and replica)
	offset        atomic.Int64 // Replication offset (both master and replica) - thread-safe
}

type ConfigOptions struct {
	Port          int
	Role          ServerRole
	MasterAddress string
}

var (
	instance *Config
	once     sync.Once
)

func Init(opts *ConfigOptions) {
	once.Do(func() {
		instance = &Config{
			Host:          "0.0.0.0",
			Port:          6379,
			Role:          Master,
			ReplicationID: utils.GenerateReplicationID(),
		}
		instance.offset.Store(0)

		if opts.Port != 0 {
			instance.Port = opts.Port
		}

		if opts.Role != "" {
			instance.Role = opts.Role
		}

		if opts.MasterAddress != "" {
			parts := strings.Split(opts.MasterAddress, " ")
			instance.MasterHost, instance.MasterPort = parts[0], parts[1]
		}

		if instance.Role == Slave {
			instance.ReplicationID = "?"
			instance.offset.Store(-1)
		}
	})
}

func GetInstance() *Config {
	if instance == nil {
		Init(&ConfigOptions{})
	}
	return instance
}

// String returns replication info for INFO command
func (config *Config) String() string {
	return fmt.Sprintf(
		"role:%s\nmaster_replid:%s\nmaster_repl_offset:%d",
		config.Role,
		config.ReplicationID,
		config.GetOffset(),
	)
}

// GetOffset returns the current offset value (thread-safe)
func (config *Config) GetOffset() int {
	return int(config.offset.Load())
}

// SetOffset sets the offset value (thread-safe)
func (config *Config) SetOffset(value int) {
	config.offset.Store(int64(value))
}

// AddOffset atomically adds delta to the offset and returns the new value (thread-safe)
func (config *Config) AddOffset(delta int) int {
	return int(config.offset.Add(int64(delta)))
}
